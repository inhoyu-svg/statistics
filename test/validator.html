<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Statistics JSON ë™ì‘ ê²€ì¦ê¸°</title>
  <style>
    /* í°íŠ¸ */
    @font-face {
      font-family: 'SCDream';
      src: url('../frame-test/frame-test/public/assets/fonts/SCDream/SCDream3.otf') format('opentype');
      font-weight: 300;
    }
    @font-face {
      font-family: 'SCDream';
      src: url('../frame-test/frame-test/public/assets/fonts/SCDream/SCDream5.otf') format('opentype');
      font-weight: 500;
    }

    /* ë‹¤í¬ í…Œë§ˆ */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #1a1a2e;
      color: #eee;
      font-family: 'SCDream', -apple-system, BlinkMacSystemFont, sans-serif;
      font-weight: 300;
      line-height: 1.6;
    }

    h1 {
      text-align: center;
      padding: 24px;
      font-weight: 500;
      color: #8DCF66;
    }

    .container {
      display: flex;
      gap: 24px;
      padding: 0 24px 24px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* ì¢Œì¸¡: JSON ì…ë ¥ */
    .input-section {
      flex: 1;
      min-width: 400px;
    }

    .input-section h2 {
      margin-bottom: 12px;
      font-weight: 500;
    }

    .input-section textarea {
      width: 100%;
      height: 500px;
      background: #252540;
      color: #eee;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 16px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      resize: vertical;
    }

    .input-section textarea:focus {
      outline: none;
      border-color: #8DCF66;
    }

    .input-section textarea::placeholder {
      color: #666;
    }

    /* ë²„íŠ¼ ê·¸ë£¹ */
    .button-group {
      margin-top: 12px;
      display: flex;
      gap: 8px;
    }

    button {
      background: #8DCF66;
      color: #000;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 500;
      font-size: 14px;
      transition: background 0.2s;
    }

    button:hover {
      background: #7bc156;
    }

    /* ìš°ì¸¡: í•„ë“œë³„ ê²°ê³¼ */
    .result-section {
      flex: 1;
      min-width: 400px;
    }

    .result-section h2 {
      margin-bottom: 12px;
      font-weight: 500;
    }

    #fieldResults {
      /* ìŠ¤í¬ë¡¤ ì—†ì´ ì „ì²´ í‘œì‹œ */
    }

    .empty-state {
      color: #666;
      padding: 24px;
      text-align: center;
      background: #252540;
      border-radius: 8px;
    }

    /* JSON ë¬¸ë²• ì—ëŸ¬ */
    .json-error {
      background: #3a2020;
      border: 1px solid #ff6b6b;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .json-error-title {
      color: #ff6b6b;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .json-error-message {
      font-family: monospace;
      font-size: 12px;
      color: #ffaaaa;
    }

    .error-context {
      margin-top: 12px;
      background: #1a1a2e;
      border-radius: 6px;
      padding: 12px;
    }

    .error-location {
      color: #ff6b6b;
      font-size: 12px;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .code-preview {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      line-height: 1.5;
    }

    .code-line {
      display: flex;
      white-space: pre;
    }

    .code-line .line-num {
      color: #666;
      width: 30px;
      text-align: right;
      margin-right: 12px;
      user-select: none;
    }

    .code-line .line-content {
      color: #aaa;
    }

    .code-line.error-line .line-content {
      color: #fff;
    }

    .error-char {
      background: #ff6b6b;
      color: #fff;
      padding: 0 2px;
      border-radius: 2px;
    }

    .error-pointer {
      display: flex;
      color: #ff6b6b;
      font-size: 11px;
    }

    .error-pointer .line-num {
      width: 30px;
      margin-right: 12px;
    }

    .error-pointer .pointer {
      white-space: pre;
    }

    /* í•„ë“œ ì•„ì´í…œ */
    .field-item {
      background: #252540;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 8px;
      border-left: 4px solid;
    }

    .field-item.valid {
      border-color: #8DCF66;
    }

    .field-item.invalid {
      border-color: #ff6b6b;
    }

    .field-item.warning {
      border-color: #f0ad4e;
    }

    .field-item.skipped {
      border-color: #666;
      opacity: 0.6;
    }

    .field-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .field-name {
      font-weight: 500;
      font-family: monospace;
      font-size: 14px;
    }

    .field-status {
      font-size: 16px;
    }

    .field-desc {
      color: #888;
      font-size: 12px;
      margin-bottom: 8px;
    }

    .field-value {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .field-value code {
      background: #1a1a2e;
      padding: 4px 8px;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      max-width: 100%;
      overflow-x: auto;
      word-break: break-all;
    }

    .default-badge {
      background: #444;
      color: #aaa;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      text-transform: uppercase;
    }

    .field-error {
      color: #ff6b6b;
      margin-top: 8px;
      font-size: 13px;
    }

    .field-warning {
      color: #f0ad4e;
      margin-top: 8px;
      font-size: 12px;
    }

    .field-warning::before {
      content: 'ğŸ’¡ ';
    }

    /* ì „ì²´ ê²°ê³¼ ìš”ì•½ */
    .result-summary {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-weight: 500;
    }

    .result-summary.success {
      background: #203a20;
      border: 1px solid #8DCF66;
      color: #8DCF66;
    }

    .result-summary.error {
      background: #3a2020;
      border: 1px solid #ff6b6b;
      color: #ff6b6b;
    }

    .result-summary.warning {
      background: #3a3520;
      border: 1px solid #f0ad4e;
      color: #f0ad4e;
    }

    .recommendations-section {
      margin-bottom: 16px;
    }

    /* ë¯¸ë¦¬ë³´ê¸° (JSON ì…ë ¥ ì•„ë˜) */
    .preview-section {
      margin-top: 16px;
    }

    .preview-section h3 {
      margin-bottom: 12px;
      font-weight: 500;
      font-size: 14px;
      color: #888;
    }

    #previewContainer {
      background: #252540;
      border-radius: 8px;
      padding: 16px;
      display: flex;
      justify-content: center;
    }

    #previewContainer canvas {
      max-width: 100%;
      height: auto;
    }

    /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #1a1a2e;
    }

    ::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <h1>viz-api JSON ê²€ì¦ê¸°</h1>

  <div class="container">
    <!-- ì¢Œì¸¡: JSON ì…ë ¥ -->
    <div class="input-section">
      <h2>JSON ì…ë ¥</h2>
      <textarea id="jsonInput" placeholder='{
  "data": [62, 87, 97, 73, 59],
  "classCount": 5,
  "options": {
    "showHistogram": true,
    "showPolygon": true
  }
}'></textarea>
      <div class="button-group">
        <button id="validateBtn">ê²€ì¦í•˜ê¸°</button>
      </div>

      <!-- ë¯¸ë¦¬ë³´ê¸° (JSON ì…ë ¥ ì•„ë˜) -->
      <div class="preview-section" id="previewSection" style="display:none">
        <h3>ë¯¸ë¦¬ë³´ê¸°</h3>
        <div id="previewContainer"></div>
      </div>
    </div>

    <!-- ìš°ì¸¡: í•„ë“œë³„ ê²°ê³¼ -->
    <div class="result-section">
      <h2>í•„ë“œë³„ ê²€ì¦ ê²°ê³¼</h2>
      <div id="fieldResults">
        <div class="empty-state">
          JSONì„ ì…ë ¥í•˜ê³  ê²€ì¦í•˜ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { ConfigValidator } from '../js/utils/validator.js';
    import * as VizAPI from '../js/viz-api.js';

    // ê¶Œì¥ì‚¬í•­ ì²´í¬ í•¨ìˆ˜ë“¤
    const RECOMMENDATIONS = {
      // í…Œì´ë¸”ì¸ë° purpose ëª…ì‹œ ì•ˆí•¨
      missingTablePurpose: (config) => {
        if (config.purpose) return null;
        const tablePatterns = ['í—¤ë”:', 'í—¤ë” :', 'Header:', 'header:'];
        const looksLikeTable = typeof config.data === 'string' &&
          tablePatterns.some(p => config.data.includes(p));
        if (looksLikeTable) {
          return {
            message: 'í…Œì´ë¸” ë°ì´í„°ë¡œ ë³´ì…ë‹ˆë‹¤. "purpose": "table" ëª…ì‹œë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.',
            fields: ['purpose']
          };
        }
        return null;
      },

      // classRange ì‚¬ìš© ë¹„ê¶Œì¥
      classRangeUsage: (config) => {
        if (config.classRange) {
          return {
            message: 'classRangeëŠ” ë³µìˆ˜ ë„ìˆ˜ë‹¤ê°í˜• ì˜¤ë²„ë ˆì´ ìš©ë„ë¡œë§Œ ê¶Œì¥ë©ë‹ˆë‹¤. ì¼ë°˜ì ì¸ ê²½ìš° classCount + classWidth ì¡°í•©ì„ ì‚¬ìš©í•˜ì„¸ìš”.',
            fields: ['classRange']
          };
        }
        return null;
      },

      // ìº”ë²„ìŠ¤ í¬ê¸° ê¶Œì¥ì‚¬í•­
      canvasSizeRecommendation: (config) => {
        const purpose = config.purpose || 'chart';

        // canvasWidthì™€ canvasHeight ë™ì‹œ ì‚¬ìš©
        if (config.canvasWidth && config.canvasHeight && !config.canvasSize) {
          if (purpose === 'table') {
            return {
              message: 'í…Œì´ë¸”ì€ canvasWidth ë˜ëŠ” canvasHeight ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤. ë™ì‹œ ì§€ì • ì‹œ ë¹„ìœ¨ì´ ì™œê³¡ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
              fields: ['canvasWidth', 'canvasHeight']
            };
          }
        }

        // í…Œì´ë¸”ì¸ë° canvasSize ì‚¬ìš©
        if (purpose === 'table' && config.canvasSize) {
          return {
            message: 'í…Œì´ë¸”ì€ canvasWidth ë˜ëŠ” canvasHeight ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤.',
            fields: ['canvasSize']
          };
        }

        return null;
      },

      // callout.preset ë¶ˆí•„ìš”
      calloutPreset: (config) => {
        if (config.options?.callout?.preset) {
          return {
            message: 'callout.presetì€ ë„ìˆ˜ë‹¤ê°í˜• ìƒ‰ìƒì„ ìë™ìœ¼ë¡œ ë”°ë¥´ë¯€ë¡œ ìƒëµí•´ë„ ë©ë‹ˆë‹¤.',
            fields: ['options']
          };
        }
        return null;
      },

      // showDashedLines + showYLabels
      dashedLinesYLabels: (config) => {
        if (config.options?.showDashedLines && config.options?.axis?.showYLabels !== false) {
          return {
            message: 'showDashedLines ì‚¬ìš© ì‹œ Yì¶• ë¼ë²¨ê³¼ ì¤‘ë³µë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. axis.showYLabels: false ê¶Œì¥í•©ë‹ˆë‹¤.',
            fields: ['options']
          };
        }
        return null;
      },

      // blinkEnabled ì—†ì´ duration/repeat ì‚¬ìš©
      cellAnimationBlink: (config) => {
        const anims = config.cellAnimations || config.options?.cellAnimations;
        if (!anims) return null;

        const hasTimingWithoutBlink = anims.some(a =>
          (a.duration || a.repeat) &&
          !config.cellAnimationOptions?.blinkEnabled
        );

        if (hasTimingWithoutBlink) {
          return {
            message: 'duration/repeatì€ cellAnimationOptions.blinkEnabled: trueì¼ ë•Œë§Œ ì ìš©ë©ë‹ˆë‹¤.',
            fields: ['cellAnimations']
          };
        }
        return null;
      },

      // animation: trueì¸ë° cellAnimations ì—†ìŒ
      animationWithoutCellAnimations: (config) => {
        const animation = config.animation;
        const hasAnimation = animation === true || animation?.enabled === true;
        const hasCellAnimations = config.cellAnimations && config.cellAnimations.length > 0;

        if (hasAnimation && !hasCellAnimations) {
          return {
            message: 'animationì´ í™œì„±í™”ë˜ì–´ ìˆì§€ë§Œ cellAnimationsê°€ ì—†ìŠµë‹ˆë‹¤. ì…€ ì• ë‹ˆë©”ì´ì…˜ì„ ì‚¬ìš©í•˜ë ¤ë©´ cellAnimationsë¥¼ ì¶”ê°€í•˜ì„¸ìš”.',
            fields: ['animation', 'cellAnimations']
          };
        }
        return null;
      },

      // customYInterval ê¶Œì¥ ê°’
      customYInterval: (config) => {
        const interval = config.options?.customYInterval;
        if (!interval) return null;

        const dataType = config.options?.dataType || 'relativeFrequency';
        if (dataType === 'frequency' && !Number.isInteger(interval)) {
          return {
            message: 'ë„ìˆ˜ ëª¨ë“œì—ì„œ customYIntervalì€ ì •ìˆ˜(1, 2, 5, 10 ë“±)ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.',
            fields: ['options']
          };
        }
        if (dataType === 'relativeFrequency' && interval >= 1) {
          return {
            message: 'ìƒëŒ€ë„ìˆ˜ ëª¨ë“œì—ì„œ customYIntervalì€ ì†Œìˆ˜(0.05, 0.1 ë“±)ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.',
            fields: ['options']
          };
        }
        return null;
      }
    };

    // ì „ì²´ ê¶Œì¥ì‚¬í•­ ì²´í¬
    function checkRecommendations(config) {
      const warnings = [];
      const warningFields = new Set();

      for (const [key, checkFn] of Object.entries(RECOMMENDATIONS)) {
        const result = checkFn(config);
        if (result) {
          warnings.push({ key, message: result.message, fields: result.fields || [] });
          // ê²½ê³  ê´€ë ¨ í•„ë“œë“¤ ìˆ˜ì§‘
          (result.fields || []).forEach(f => warningFields.add(f));
        }
      }

      return { warnings, warningFields };
    }

    // ê²€ì¦í•  í•„ë“œ ì •ì˜
    const FIELD_DEFINITIONS = {
      data: { required: true, label: 'data', desc: 'ë³€ëŸ‰ ë°ì´í„° (í•„ìˆ˜)' },
      purpose: { required: false, label: 'purpose', desc: 'ë Œë”ë§ ëª©ì ', default: 'chart' },
      tableType: { required: false, label: 'tableType', desc: 'í…Œì´ë¸” íƒ€ì…', default: 'basic-table' },
      classCount: { required: false, label: 'classCount', desc: 'ê³„ê¸‰ ê°œìˆ˜ (3~20)', default: 5 },
      classWidth: { required: false, label: 'classWidth', desc: 'ê³„ê¸‰ ê°„ê²©' },
      classRange: { required: false, label: 'classRange', desc: 'ê³„ê¸‰ ë²”ìœ„ ìˆ˜ë™ ì§€ì •' },
      canvasSize: { required: false, label: 'canvasSize', desc: 'ìº”ë²„ìŠ¤ í¬ê¸°' },
      canvasWidth: { required: false, label: 'canvasWidth', desc: 'ìº”ë²„ìŠ¤ ë„ˆë¹„', default: 700 },
      canvasHeight: { required: false, label: 'canvasHeight', desc: 'ìº”ë²„ìŠ¤ ë†’ì´', default: 450 },
      cellVariables: { required: false, label: 'cellVariables', desc: 'ì…€ ë³€ìˆ˜ ì¹˜í™˜' },
      cellAnimations: { required: false, label: 'cellAnimations', desc: 'ì…€ ì• ë‹ˆë©”ì´ì…˜' },
      animation: { required: false, label: 'animation', desc: 'ì• ë‹ˆë©”ì´ì…˜ í™œì„±í™”', default: true },
      options: { required: false, label: 'options', desc: 'ì„¸ë¶€ ì˜µì…˜' }
    };

    // DOM ìš”ì†Œ
    const jsonInput = document.getElementById('jsonInput');
    const validateBtn = document.getElementById('validateBtn');
    const fieldResults = document.getElementById('fieldResults');
    const previewSection = document.getElementById('previewSection');
    const previewContainer = document.getElementById('previewContainer');

    // ê²€ì¦ í•¨ìˆ˜
    function validateJson() {
      const input = jsonInput.value.trim();

      if (!input) {
        showEmptyState();
        hidePreview();
        return;
      }

      // 1. JSON íŒŒì‹±
      let config;
      try {
        config = JSON.parse(input);
      } catch (e) {
        showJsonSyntaxError(e);
        hidePreview();
        return;
      }

      // 2. ConfigValidatorë¡œ ì „ì²´ ê²€ì¦
      const purpose = config.purpose || 'chart';
      const result = ConfigValidator.validate(config, purpose);

      // 3. ê¶Œì¥ì‚¬í•­ ì²´í¬
      const { warnings, warningFields } = checkRecommendations(config);

      // 4. í•„ë“œë³„ ê²°ê³¼ ìƒì„± ë° ë Œë”ë§
      const fields = buildFieldResults(config, result, warningFields);
      renderFieldResults(fields, result.valid, warnings);

      // 4. ë¯¸ë¦¬ë³´ê¸° (ìœ íš¨í•  ë•Œë§Œ)
      if (result.valid) {
        renderPreview(config, purpose);
      } else {
        hidePreview();
      }
    }

    // ë¹ˆ ìƒíƒœ í‘œì‹œ
    function showEmptyState() {
      fieldResults.innerHTML = `
        <div class="empty-state">
          JSONì„ ì…ë ¥í•˜ê³  ê²€ì¦í•˜ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.
        </div>
      `;
    }

    // JSON ë¬¸ë²• ì—ëŸ¬ í‘œì‹œ
    function showJsonSyntaxError(error) {
      const input = jsonInput.value;
      const errorInfo = parseJsonErrorPosition(error.message, input);

      let errorContextHtml = '';
      if (errorInfo.line !== null) {
        const lines = input.split('\n');
        const startLine = Math.max(0, errorInfo.line - 2);
        const endLine = Math.min(lines.length, errorInfo.line + 2);

        const contextLines = [];
        for (let i = startLine; i < endLine; i++) {
          const lineNum = i + 1;
          const isErrorLine = i === errorInfo.line;
          const lineContent = escapeHtml(lines[i] || '');

          if (isErrorLine) {
            // ì—ëŸ¬ ìœ„ì¹˜ í‘œì‹œ
            const col = errorInfo.column || 0;
            const before = lineContent.substring(0, col);
            const errorChar = lineContent.substring(col, col + 1) || ' ';
            const after = lineContent.substring(col + 1);

            contextLines.push(
              `<div class="code-line error-line">` +
              `<span class="line-num">${lineNum}</span>` +
              `<span class="line-content">${before}<span class="error-char">${errorChar}</span>${after}</span>` +
              `</div>`
            );
            // ì—ëŸ¬ í¬ì¸í„°
            contextLines.push(
              `<div class="error-pointer">` +
              `<span class="line-num"></span>` +
              `<span class="pointer">${' '.repeat(col)}^ ì—¬ê¸°</span>` +
              `</div>`
            );
          } else {
            contextLines.push(
              `<div class="code-line">` +
              `<span class="line-num">${lineNum}</span>` +
              `<span class="line-content">${lineContent}</span>` +
              `</div>`
            );
          }
        }

        errorContextHtml = `
          <div class="error-context">
            <div class="error-location">ì¤„ ${errorInfo.line + 1}, ì—´ ${(errorInfo.column || 0) + 1}</div>
            <div class="code-preview">${contextLines.join('')}</div>
          </div>
        `;
      }

      fieldResults.innerHTML = `
        <div class="json-error">
          <div class="json-error-title">JSON ë¬¸ë²• ì˜¤ë¥˜</div>
          <div class="json-error-message">${escapeHtml(error.message)}</div>
          ${errorContextHtml}
        </div>
        <div class="empty-state">
          JSON ë¬¸ë²•ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
        </div>
      `;
    }

    // JSON ì—ëŸ¬ ë©”ì‹œì§€ì—ì„œ ìœ„ì¹˜ íŒŒì‹±
    function parseJsonErrorPosition(message, input) {
      let position = null;

      // "at position 123" íŒ¨í„´
      const posMatch = message.match(/position\s+(\d+)/i);
      if (posMatch) {
        position = parseInt(posMatch[1], 10);
      }

      // "at line 1 column 5" íŒ¨í„´
      const lineColMatch = message.match(/line\s+(\d+)\s+column\s+(\d+)/i);
      if (lineColMatch) {
        return {
          line: parseInt(lineColMatch[1], 10) - 1,
          column: parseInt(lineColMatch[2], 10) - 1
        };
      }

      // positionìœ¼ë¡œë¶€í„° line/column ê³„ì‚°
      if (position !== null) {
        let line = 0;
        let col = 0;
        for (let i = 0; i < position && i < input.length; i++) {
          if (input[i] === '\n') {
            line++;
            col = 0;
          } else {
            col++;
          }
        }
        return { line, column: col };
      }

      return { line: null, column: null };
    }

    // í•„ë“œë³„ ê²°ê³¼ ìƒì„±
    function buildFieldResults(config, validationResult, warningFields = new Set()) {
      const fields = [];
      const errorMap = new Map(validationResult.errors.map(e => [e.field, e]));

      for (const [key, def] of Object.entries(FIELD_DEFINITIONS)) {
        const hasValue = config.hasOwnProperty(key);
        const value = config[key];
        const error = errorMap.get(key);
        const hasWarning = warningFields.has(key);

        // í…Œì´ë¸” ì „ìš© í•„ë“œ ì²´í¬
        const purpose = config.purpose || 'chart';
        const isTableOnlyField = ['tableType'].includes(key);
        const isChartOnlyField = ['classCount', 'classWidth', 'classRange'].includes(key);

        // ê´€ë ¨ ì—†ëŠ” í•„ë“œëŠ” ìŠ¤í‚µ
        if (purpose === 'chart' && isTableOnlyField && !hasValue) continue;
        if (purpose === 'table' && isChartOnlyField && !hasValue) continue;

        fields.push({
          name: def.label,
          desc: def.desc,
          hasValue,
          value: hasValue ? value : def.default,
          isDefault: !hasValue && def.default !== undefined,
          valid: !error,
          error: error?.message,
          required: def.required,
          hasWarning
        });
      }

      return fields;
    }

    // í•„ë“œë³„ ê²°ê³¼ ë Œë”ë§
    function renderFieldResults(fields, isValid, recommendations = []) {
      const hasWarnings = recommendations.length > 0;

      let summaryText = isValid ? 'ëª¨ë“  í•„ë“œê°€ ìœ íš¨í•©ë‹ˆë‹¤' : 'ì¼ë¶€ í•„ë“œì— ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤';
      let summaryClass = isValid ? 'success' : 'error';

      if (isValid && hasWarnings) {
        summaryText = `ìœ íš¨í•˜ì§€ë§Œ ${recommendations.length}ê°œì˜ ê¶Œì¥ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤`;
        summaryClass = 'warning';
      }

      const summaryHtml = `
        <div class="result-summary ${summaryClass}">
          ${summaryText}
        </div>
      `;

      // ê¶Œì¥ì‚¬í•­ ì„¹ì…˜
      const warningsHtml = hasWarnings ? `
        <div class="recommendations-section">
          <h4 style="color: #f0ad4e; margin-bottom: 8px; font-size: 13px;">ê¶Œì¥ì‚¬í•­</h4>
          ${recommendations.map(r => `
            <div class="field-item warning">
              <div class="field-warning">${escapeHtml(r.message)}</div>
            </div>
          `).join('')}
        </div>
      ` : '';

      const fieldsHtml = fields.map(f => {
        // ìš°ì„ ìˆœìœ„: error > warning > valid
        let statusClass = 'valid';
        if (!f.valid) statusClass = 'invalid';
        else if (f.hasWarning) statusClass = 'warning';

        return `
          <div class="field-item ${statusClass}">
            <div class="field-header">
              <span class="field-name">${f.name}${f.required ? ' *' : ''}</span>
              <span class="field-status"></span>
            </div>
            <div class="field-desc">${f.desc}</div>
            <div class="field-value">
              ${f.isDefault ? '<span class="default-badge">ê¸°ë³¸ê°’</span>' : ''}
              <code>${formatValue(f.value)}</code>
            </div>
            ${f.error ? `<div class="field-error">${escapeHtml(f.error)}</div>` : ''}
          </div>
        `;
      }).join('');

      fieldResults.innerHTML = summaryHtml + warningsHtml + fieldsHtml;
    }

    // ê°’ í¬ë§·íŒ… (ë°°ì—´/ê°ì²´ëŠ” ì¶•ì•½)
    function formatValue(value) {
      if (value === undefined) return '<em style="color:#666">ë¯¸ì„¤ì •</em>';
      if (value === null) return 'null';

      if (Array.isArray(value)) {
        if (value.length === 0) return '[]';
        if (value.length > 5) {
          return `[${value.slice(0, 3).join(', ')}, ... +${value.length - 3}ê°œ]`;
        }
        return JSON.stringify(value);
      }

      if (typeof value === 'object') {
        const keys = Object.keys(value);
        if (keys.length === 0) return '{}';
        if (keys.length > 3) {
          return `{ ${keys.slice(0, 3).join(', ')}, ... }`;
        }
        return JSON.stringify(value);
      }

      if (typeof value === 'string' && value.includes('\n')) {
        return `"${value.substring(0, 30)}..."`;
      }

      return JSON.stringify(value);
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§
    async function renderPreview(config, purpose) {
      previewContainer.innerHTML = '';

      try {
        // ì‘ì€ ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
        const smallConfig = {
          ...config,
          canvasSize: 400,
          animation: false
        };

        if (purpose === 'chart') {
          await VizAPI.renderChart(previewContainer, smallConfig);
        } else {
          await VizAPI.renderTable(previewContainer, smallConfig);
        }

        previewSection.style.display = 'block';
      } catch (e) {
        console.error('ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§ ì‹¤íŒ¨:', e);
        previewContainer.innerHTML = `<div style="color:#ff6b6b;">ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§ ì‹¤íŒ¨: ${escapeHtml(e.message)}</div>`;
        previewSection.style.display = 'block';
      }
    }

    // ë¯¸ë¦¬ë³´ê¸° ìˆ¨ê¸°ê¸°
    function hidePreview() {
      previewSection.style.display = 'none';
      previewContainer.innerHTML = '';
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    validateBtn.addEventListener('click', validateJson);

    // Enter í‚¤ë¡œ ê²€ì¦ (Ctrl+Enter)
    jsonInput.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'Enter') {
        validateJson();
      }
    });
  </script>
</body>
</html>
